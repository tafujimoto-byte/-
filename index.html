<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自習室よやくアプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            /* スクロールバーのカスタマイズ */
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* 座席のポップアニメーション */
        .pop-in { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .seat-grid {
            display: grid;
            gap: 0.5rem;
            /* width/columnsはJSで動的に設定 */
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen text-slate-700 flex flex-col">

    <!-- ヘッダー -->
    <header class="bg-white shadow-sm border-b-4 border-sky-400 sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="switchView('student')">
                <div class="bg-sky-100 p-2 rounded-xl text-sky-600">
                    <i data-lucide="library" class="w-6 h-6"></i>
                </div>
                <h1 class="text-xl md:text-2xl font-black text-sky-900 tracking-wide">自習室よやく</h1>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- 管理者モードへの隠しボタン -->
                <button onclick="promptAdminAuth()" class="p-2 text-slate-300 hover:text-slate-500 bg-transparent rounded-xl transition-colors" title="管理者設定">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-6xl w-full mx-auto px-2 md:px-4 py-6 relative flex flex-col">

        <!-- ========================================== -->
        <!-- 画面1: 生徒用（予約画面） -->
        <!-- ========================================== -->
        <div id="view-student" class="flex-grow flex flex-col gap-4">
            
            <!-- 日付選択 -->
            <div class="bg-white rounded-2xl p-2 shadow-sm border border-slate-200 flex overflow-x-auto no-scrollbar gap-2" id="date-selector">
                <!-- JSで日付ボタンを生成 -->
            </div>

            <!-- 教室選択 -->
            <div class="flex overflow-x-auto no-scrollbar gap-2 pb-2" id="room-tabs">
                <!-- JSで教室タブを生成 -->
            </div>

            <!-- 座席マップエリア -->
            <div class="bg-white rounded-3xl p-4 md:p-8 shadow-md border-2 border-slate-100 flex-grow flex flex-col">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-xl md:text-2xl font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="map" class="w-6 h-6 text-sky-500"></i> 座席表
                        </h2>
                        <p id="current-selection-info" class="text-sm font-bold text-slate-500 mt-1"></p>
                    </div>
                    <div class="flex gap-4 text-xs font-bold text-slate-500">
                        <div class="flex items-center gap-1"><div class="w-4 h-4 rounded bg-sky-100 border-2 border-sky-300"></div> 空席</div>
                        <div class="flex items-center gap-1"><div class="w-4 h-4 rounded bg-rose-100 border-2 border-rose-300"></div> 予約済</div>
                        <div class="flex items-center gap-1"><div class="w-4 h-4 rounded bg-emerald-100 border-2 border-emerald-400"></div> 自分の席</div>
                    </div>
                </div>

                <!-- 教卓（黒板）の表現 -->
                <div class="w-2/3 max-w-md mx-auto bg-slate-200 rounded-b-xl py-2 mb-8 text-center font-black text-slate-500 tracking-widest shadow-inner border-b-4 border-slate-300">
                    前 方（教 卓）
                </div>

                <!-- 座席グリッド -->
                <div class="flex-grow overflow-auto p-2 pb-8 flex justify-center">
                    <div id="seat-map" class="seat-grid">
                        <!-- JSで座席を生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- 画面2: 管理者用（設定画面） -->
        <!-- ========================================== -->
        <div id="view-admin" class="hidden flex-grow flex flex-col gap-6">
            <div class="bg-slate-800 text-white p-4 rounded-2xl flex justify-between items-center shadow-lg">
                <h2 class="text-xl font-black flex items-center gap-2">
                    <i data-lucide="shield-check" class="w-6 h-6 text-amber-400"></i> 管理者モード
                </h2>
                <button onclick="switchView('student')" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl font-bold transition-colors text-sm">
                    生徒画面に戻る
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 教室リスト -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border-2 border-slate-200 lg:col-span-1">
                    <h3 class="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">
                        <i data-lucide="door-open" class="w-5 h-5 text-indigo-500"></i> 教室の管理
                    </h3>
                    <div id="admin-room-list" class="space-y-2 mb-4">
                        <!-- JSで教室リスト生成 -->
                    </div>
                    <button onclick="createNewRoom()" class="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 border-2 border-dashed border-indigo-200 py-3 rounded-xl font-bold transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i> 新しい教室を追加
                    </button>
                </div>

                <!-- レイアウトエディタ -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border-2 border-slate-200 lg:col-span-2 flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="layout-dashboard" class="w-5 h-5 text-indigo-500"></i> レイアウト編集
                        </h3>
                        <button onclick="saveRoomLayout()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold shadow-md transition-colors flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i> 保存する
                        </button>
                    </div>

                    <div id="editor-container" class="hidden flex-col gap-4">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-200">
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-slate-500 mb-1">教室名</label>
                                <input type="text" id="edit-room-name" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 font-bold focus:outline-none focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">たて（行）</label>
                                <input type="number" id="edit-room-rows" min="1" max="20" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 font-bold focus:outline-none focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">よこ（列）</label>
                                <input type="number" id="edit-room-cols" min="1" max="20" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 font-bold focus:outline-none focus:border-indigo-500">
                            </div>
                            <div class="col-span-full flex justify-end">
                                <button onclick="updateEditorGridSize()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold text-sm transition-colors">
                                    マス目をリセットして更新
                                </button>
                            </div>
                        </div>

                        <p class="text-sm font-bold text-slate-500 mt-2"><i data-lucide="info" class="w-4 h-4 inline align-middle"></i> マスをクリックすると「座席」と「通路」が切り替わります。</p>
                        
                        <!-- エディタ用グリッド -->
                        <div class="overflow-auto bg-slate-100 p-4 rounded-2xl border-2 border-slate-200 flex justify-center min-h-[300px]">
                            <div id="editor-grid" class="seat-grid">
                                <!-- JSでエディタグリッド生成 -->
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-slate-200 flex justify-between items-center">
                            <span class="text-sm font-bold text-rose-500">※保存せずに他の教室を選ぶと変更が消えます</span>
                            <button onclick="deleteCurrentRoom()" class="text-rose-600 bg-rose-50 hover:bg-rose-100 px-4 py-2 rounded-xl font-bold transition-colors text-sm flex items-center gap-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> この教室を削除
                            </button>
                        </div>
                    </div>
                    
                    <div id="editor-empty" class="flex-grow flex flex-col items-center justify-center text-slate-400 gap-2 pb-10">
                        <i data-lucide="mouse-pointer-click" class="w-12 h-12 opacity-50"></i>
                        <p class="font-bold">左のリストから編集する教室を選んでください</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ========================================== -->
    <!-- モーダル: 予約/キャンセル入力 -->
    <!-- ========================================== -->
    <div id="modal-reserve" class="hidden fixed inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 transition-opacity">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 transform scale-95 transition-transform" id="modal-reserve-content">
            <div class="text-center mb-6">
                <div id="modal-icon" class="w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-3"></div>
                <h3 id="modal-title" class="text-xl font-black text-slate-800"></h3>
                <p id="modal-desc" class="text-sm font-bold text-slate-500 mt-1"></p>
            </div>
            
            <div id="modal-input-area" class="mb-6">
                <label class="block text-sm font-bold text-slate-600 mb-2">あなたの名前（フルネーム）</label>
                <input type="text" id="student-name" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-800 focus:outline-none focus:border-sky-400 focus:ring-2 focus:ring-sky-100 placeholder-slate-400" placeholder="例：山田 太郎">
            </div>

            <div class="flex gap-3">
                <button onclick="closeModal('reserve')" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 rounded-xl transition-colors">やめる</button>
                <button id="modal-action-btn" class="flex-1 font-bold py-3 rounded-xl transition-colors text-white shadow-md"></button>
            </div>
        </div>
    </div>

    <!-- モーダル: 管理者認証 -->
    <div id="modal-auth" class="hidden fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-[2rem] shadow-2xl p-6 text-center">
            <div class="bg-amber-100 w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-4 text-amber-500">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h3 class="text-lg font-black text-slate-800 mb-2">管理者用パスワード</h3>
            <p class="text-xs font-bold text-slate-500 mb-4">初期パスワードは「0000」です</p>
            <input type="password" id="admin-pin" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-3 font-black text-center text-xl tracking-widest text-slate-800 focus:outline-none focus:border-amber-400 mb-4" maxlength="4">
            <div class="flex gap-2">
                <button onclick="closeModal('auth')" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-2 rounded-xl transition-colors">戻る</button>
                <button onclick="checkAdminAuth()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 rounded-xl shadow-md transition-colors">確認</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 状態管理・初期データ
        // ==========================================
        const ADMIN_PIN = "0000";

        let appData = {
            rooms: [
                {
                    id: 'room_1',
                    name: '図書室（自習スペース）',
                    rows: 6,
                    cols: 5,
                    layout: [
                        [1,1,0,1,1],
                        [1,1,0,1,1],
                        [1,1,0,1,1],
                        [0,0,0,0,0], // 通路
                        [1,1,0,1,1],
                        [1,1,0,1,1]
                    ]
                }
            ],
            reservations: {} // key: "roomID_YYYY-MM-DD", value: {"r-c": "名前"}
        };

        // このデバイスでの予約記録（キャンセル許可のため）
        // myReservations = ["room_1_2026-02-27_0-0", ...]
        let myReservations = []; 

        let state = {
            currentDate: '',     // YYYY-MM-DD
            currentRoomId: '',
            dates: [],           // [{dateStr: '...', label: '今日'}, ...]
            isAdmin: false,
            
            // 予約モーダル用の一時データ
            targetSeat: { r: -1, c: -1, isReserved: false, resName: '' },

            // 管理者エディタ用の一時データ
            editRoomId: '',
            editLayout: [] 
        };

        // ==========================================
        // 初期化処理
        // ==========================================
        function init() {
            lucide.createIcons();
            loadData();
            setupDates();
            
            if (appData.rooms.length > 0) {
                state.currentRoomId = appData.rooms[0].id;
            }

            renderStudentView();
        }

        function loadData() {
            const savedData = localStorage.getItem('study_booking_data');
            if (savedData) {
                appData = JSON.parse(savedData);
            }
            const savedMyRes = localStorage.getItem('study_booking_my_res');
            if (savedMyRes) {
                myReservations = JSON.parse(savedMyRes);
            }
        }

        function saveData() {
            localStorage.setItem('study_booking_data', JSON.stringify(appData));
            localStorage.setItem('study_booking_my_res', JSON.stringify(myReservations));
        }

        function setupDates() {
            const today = new Date();
            state.dates = [];
            const labels = ["今日", "明日", "あさって"];
            
            for (let i = 0; i < 7; i++) { // 1週間分
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const dateStr = `${yyyy}-${mm}-${dd}`;
                
                let label = `${mm}/${dd}`;
                if (i < 3) label = `${labels[i]} (${label})`;

                state.dates.push({ dateStr, label });
            }
            state.currentDate = state.dates[0].dateStr;
        }

        // ==========================================
        // UI レンダリング (生徒画面)
        // ==========================================
        function renderStudentView() {
            renderDateSelector();
            renderRoomTabs();
            renderSeatMap();
            updateSelectionInfo();
        }

        function updateSelectionInfo() {
            const room = appData.rooms.find(r => r.id === state.currentRoomId);
            const dateObj = state.dates.find(d => d.dateStr === state.currentDate);
            const el = document.getElementById('current-selection-info');
            if(room && dateObj) {
                el.innerText = `${dateObj.label} ｜ ${room.name}`;
            } else {
                el.innerText = "教室または日付が選択されていません";
            }
        }

        function renderDateSelector() {
            const container = document.getElementById('date-selector');
            container.innerHTML = '';
            
            state.dates.forEach(d => {
                const isSelected = d.dateStr === state.currentDate;
                const btn = document.createElement('button');
                btn.className = `whitespace-nowrap px-5 py-2 rounded-xl font-bold transition-all text-sm md:text-base ${isSelected ? 'bg-sky-500 text-white shadow-md scale-105' : 'bg-transparent text-slate-500 hover:bg-slate-100'}`;
                btn.innerText = d.label;
                btn.onclick = () => {
                    state.currentDate = d.dateStr;
                    renderStudentView();
                };
                container.appendChild(btn);
            });
        }

        function renderRoomTabs() {
            const container = document.getElementById('room-tabs');
            container.innerHTML = '';

            appData.rooms.forEach(room => {
                const isSelected = room.id === state.currentRoomId;
                const btn = document.createElement('button');
                btn.className = `whitespace-nowrap px-4 py-3 border-b-4 font-bold transition-colors text-sm md:text-base ${isSelected ? 'border-sky-500 text-sky-700' : 'border-transparent text-slate-400 hover:text-slate-600 hover:border-slate-300'}`;
                btn.innerHTML = `<i data-lucide="door-open" class="w-4 h-4 inline-block mb-1"></i> ${room.name}`;
                btn.onclick = () => {
                    state.currentRoomId = room.id;
                    renderStudentView();
                };
                container.appendChild(btn);
            });
            lucide.createIcons();
        }

        function renderSeatMap() {
            const container = document.getElementById('seat-map');
            container.innerHTML = '';

            const room = appData.rooms.find(r => r.id === state.currentRoomId);
            if (!room) {
                container.innerHTML = '<div class="text-slate-400 font-bold p-8">教室データがありません</div>';
                return;
            }

            // 予約データの取得
            const resKey = `${state.currentRoomId}_${state.currentDate}`;
            const reservations = appData.reservations[resKey] || {};

            // CSS Grid設定 (PC幅に合わせつつスマホでもスクロール可能に)
            // 1マスの基準を 60px 程度にする
            container.style.gridTemplateColumns = `repeat(${room.cols}, minmax(60px, 80px))`;

            let delayCount = 0;

            for (let r = 0; r < room.rows; r++) {
                for (let c = 0; c < room.cols; c++) {
                    const isSeat = room.layout[r][c] === 1;
                    const cell = document.createElement('div');
                    
                    if (!isSeat) {
                        // 通路（見えない）
                        cell.className = "aspect-square"; 
                    } else {
                        // 座席
                        const seatKey = `${r}-${c}`;
                        const resName = reservations[seatKey];
                        const myResKey = `${resKey}_${seatKey}`;
                        const isMySeat = myReservations.includes(myResKey);

                        cell.className = "aspect-square rounded-xl shadow-sm border-b-4 flex flex-col items-center justify-center cursor-pointer transition-transform hover:-translate-y-1 active:translate-y-0 pop-in select-none relative overflow-hidden";
                        cell.style.animationDelay = `${delayCount * 0.02}s`;
                        delayCount++;

                        if (resName) {
                            // 予約済み
                            if (isMySeat || state.isAdmin) {
                                // 自分の席、または管理者モード
                                cell.classList.add('bg-emerald-50', 'border-emerald-300', 'text-emerald-700');
                                cell.innerHTML = `
                                    <i data-lucide="user-check" class="w-6 h-6 mb-1 opacity-80"></i>
                                    <span class="text-[10px] font-black truncate w-full px-1 text-center">${resName}</span>
                                    ${state.isAdmin ? '<div class="absolute top-0 right-0 bg-rose-500 text-white text-[8px] px-1 rounded-bl">管理</div>' : ''}
                                `;
                                cell.onclick = () => openReserveModal(r, c, true, resName);
                            } else {
                                // 他人の席
                                cell.classList.add('bg-slate-200', 'border-slate-300', 'text-slate-500', 'cursor-not-allowed', 'hover:-translate-y-0');
                                cell.innerHTML = `
                                    <i data-lucide="user-x" class="w-6 h-6 mb-1 opacity-50"></i>
                                    <span class="text-[10px] font-black">予約済</span>
                                `;
                            }
                        } else {
                            // 空席
                            cell.classList.add('bg-white', 'border-sky-200', 'text-sky-500', 'hover:border-sky-400');
                            cell.innerHTML = `
                                <span class="text-xs font-black opacity-50 absolute top-1 left-2">${r+1}-${c+1}</span>
                                <i data-lucide="armchair" class="w-6 h-6 mb-1"></i>
                                <span class="text-[10px] font-bold">空席</span>
                            `;
                            cell.onclick = () => openReserveModal(r, c, false, '');
                        }
                    }
                    container.appendChild(cell);
                }
            }
            lucide.createIcons();
        }

        // ==========================================
        // モーダル処理 (予約・キャンセル)
        // ==========================================
        function openReserveModal(r, c, isReserved, resName) {
            state.targetSeat = { r, c, isReserved, resName };
            
            const modal = document.getElementById('modal-reserve');
            const content = document.getElementById('modal-reserve-content');
            const title = document.getElementById('modal-title');
            const desc = document.getElementById('modal-desc');
            const inputArea = document.getElementById('modal-input-area');
            const input = document.getElementById('student-name');
            const btn = document.getElementById('modal-action-btn');
            const icon = document.getElementById('modal-icon');

            input.value = '';

            const room = appData.rooms.find(rm => rm.id === state.currentRoomId);
            const seatLabel = `${room.name} (${r+1}行-${c+1}列)`;

            if (isReserved) {
                // キャンセルモード
                icon.className = "w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-3 bg-rose-100 text-rose-500";
                icon.innerHTML = '<i data-lucide="x-circle" class="w-8 h-8"></i>';
                title.innerText = "予約のキャンセル";
                desc.innerText = seatLabel;
                
                if (state.isAdmin) {
                    inputArea.classList.add('hidden');
                    desc.innerText += `\n予約者: ${resName}`;
                    btn.innerText = "強制キャンセル";
                    btn.className = "flex-1 font-bold py-3 rounded-xl transition-colors text-white shadow-md bg-rose-500 hover:bg-rose-600";
                    btn.onclick = () => executeCancel(true);
                } else {
                    inputArea.classList.remove('hidden');
                    btn.innerText = "キャンセルする";
                    btn.className = "flex-1 font-bold py-3 rounded-xl transition-colors text-white shadow-md bg-rose-500 hover:bg-rose-600";
                    btn.onclick = () => executeCancel(false);
                }
            } else {
                // 予約モード
                icon.className = "w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-3 bg-sky-100 text-sky-500";
                icon.innerHTML = '<i data-lucide="check-circle-2" class="w-8 h-8"></i>';
                title.innerText = "座席を予約する";
                desc.innerText = seatLabel;
                inputArea.classList.remove('hidden');
                
                // 過去に入力した名前があれば復元（便利機能）
                const lastName = localStorage.getItem('study_booking_last_name');
                if (lastName) input.value = lastName;

                btn.innerText = "予約する";
                btn.className = "flex-1 font-bold py-3 rounded-xl transition-colors text-white shadow-md bg-sky-500 hover:bg-sky-600";
                btn.onclick = executeReserve;
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                if(!isReserved || !state.isAdmin) input.focus();
            }, 10);
            lucide.createIcons();
        }

        function closeModal(id) {
            const modal = document.getElementById(`modal-${id}`);
            const content = modal.children[0];
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function executeReserve() {
            const name = document.getElementById('student-name').value.trim();
            if (!name) {
                alert('名前を入力してください。');
                return;
            }

            const resKey = `${state.currentRoomId}_${state.currentDate}`;
            const seatKey = `${state.targetSeat.r}-${state.targetSeat.c}`;
            
            if (!appData.reservations[resKey]) {
                appData.reservations[resKey] = {};
            }

            // 二重予約チェック（万が一他人が直前に取った場合）
            if (appData.reservations[resKey][seatKey]) {
                alert('申し訳ありません、この座席はたった今別の人が予約しました。');
                closeModal('reserve');
                renderStudentView();
                return;
            }

            appData.reservations[resKey][seatKey] = name;
            
            // 自分の予約として記録
            const myResKey = `${resKey}_${seatKey}`;
            myReservations.push(myResKey);
            localStorage.setItem('study_booking_last_name', name); // 名前を記憶

            saveData();
            closeModal('reserve');
            renderStudentView();
        }

        function executeCancel(force) {
            const resKey = `${state.currentRoomId}_${state.currentDate}`;
            const seatKey = `${state.targetSeat.r}-${state.targetSeat.c}`;
            const actualName = appData.reservations[resKey][seatKey];

            if (!force) {
                const inputName = document.getElementById('student-name').value.trim();
                if (inputName !== actualName) {
                    alert('登録されている名前と一致しません。');
                    return;
                }
            }

            delete appData.reservations[resKey][seatKey];
            
            // myReservationsからも削除
            const myResKey = `${resKey}_${seatKey}`;
            myReservations = myReservations.filter(k => k !== myResKey);

            saveData();
            closeModal('reserve');
            renderStudentView();
        }

        // ==========================================
        // モード切り替え
        // ==========================================
        function promptAdminAuth() {
            document.getElementById('admin-pin').value = '';
            const modal = document.getElementById('modal-auth');
            modal.classList.remove('hidden');
            setTimeout(() => document.getElementById('admin-pin').focus(), 100);
        }

        function checkAdminAuth() {
            const pin = document.getElementById('admin-pin').value;
            if (pin === ADMIN_PIN) {
                state.isAdmin = true;
                closeModal('auth');
                switchView('admin');
            } else {
                alert('パスワードが違います。');
                document.getElementById('admin-pin').value = '';
            }
        }

        function switchView(view) {
            document.getElementById('view-student').classList.add('hidden');
            document.getElementById('view-admin').classList.add('hidden');
            
            if (view === 'admin') {
                document.getElementById('view-admin').classList.remove('hidden');
                renderAdminRoomList();
                document.getElementById('editor-empty').classList.remove('hidden');
                document.getElementById('editor-container').classList.add('hidden');
            } else {
                state.isAdmin = false;
                document.getElementById('view-student').classList.remove('hidden');
                renderStudentView();
            }
        }

        // ==========================================
        // 管理者: レイアウトエディタ
        // ==========================================
        function renderAdminRoomList() {
            const container = document.getElementById('admin-room-list');
            container.innerHTML = '';
            
            appData.rooms.forEach(room => {
                const isEditing = room.id === state.editRoomId;
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex justify-between items-center ${isEditing ? 'bg-indigo-500 text-white shadow-md' : 'bg-slate-50 text-slate-700 hover:bg-slate-100 border border-slate-200'}`;
                btn.innerHTML = `
                    <span>${room.name}</span>
                    <span class="text-xs ${isEditing ? 'text-indigo-200' : 'text-slate-400'}">${room.rows}×${room.cols}</span>
                `;
                btn.onclick = () => loadRoomToEditor(room.id);
                container.appendChild(btn);
            });
        }

        function createNewRoom() {
            const newId = 'room_' + Date.now();
            const newRoom = {
                id: newId,
                name: '新しい教室',
                rows: 5,
                cols: 5,
                layout: Array(5).fill().map(() => Array(5).fill(1)) // 全て座席
            };
            appData.rooms.push(newRoom);
            saveData();
            renderAdminRoomList();
            loadRoomToEditor(newId);
            renderRoomTabs(); // 生徒側のタブも更新
        }

        function loadRoomToEditor(roomId) {
            state.editRoomId = roomId;
            const room = appData.rooms.find(r => r.id === roomId);
            
            // ディープコピーして編集用データを作成
            state.editLayout = JSON.parse(JSON.stringify(room.layout));
            
            document.getElementById('edit-room-name').value = room.name;
            document.getElementById('edit-room-rows').value = room.rows;
            document.getElementById('edit-room-cols').value = room.cols;
            
            document.getElementById('editor-empty').classList.add('hidden');
            document.getElementById('editor-container').classList.remove('hidden');
            document.getElementById('editor-container').classList.add('flex');
            
            renderAdminRoomList();
            renderEditorGrid();
        }

        function updateEditorGridSize() {
            const rows = parseInt(document.getElementById('edit-room-rows').value) || 5;
            const cols = parseInt(document.getElementById('edit-room-cols').value) || 5;
            
            // 新しいサイズのレイアウトを生成（既存の配置は維持しつつ拡張/縮小）
            const newLayout = [];
            for (let r = 0; r < rows; r++) {
                const row = [];
                for (let c = 0; c < cols; c++) {
                    if (r < state.editLayout.length && c < state.editLayout[r].length) {
                        row.push(state.editLayout[r][c]);
                    } else {
                        row.push(1); // 新規マスは座席(1)
                    }
                }
                newLayout.push(row);
            }
            state.editLayout = newLayout;
            renderEditorGrid();
        }

        function renderEditorGrid() {
            const container = document.getElementById('editor-grid');
            container.innerHTML = '';
            
            const rows = state.editLayout.length;
            const cols = rows > 0 ? state.editLayout[0].length : 0;
            
            // プレビュー用なので少し小さめ
            container.style.gridTemplateColumns = `repeat(${cols}, minmax(40px, 60px))`;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const isSeat = state.editLayout[r][c] === 1;
                    const cell = document.createElement('div');
                    
                    if (isSeat) {
                        cell.className = "aspect-square rounded-lg border-2 border-indigo-300 bg-indigo-50 flex items-center justify-center cursor-pointer hover:bg-indigo-100 transition-colors";
                        cell.innerHTML = '<i data-lucide="armchair" class="w-5 h-5 text-indigo-400"></i>';
                    } else {
                        cell.className = "aspect-square rounded-lg border-2 border-dashed border-slate-300 bg-transparent flex items-center justify-center cursor-pointer hover:bg-slate-200 transition-colors";
                        cell.innerHTML = '<span class="text-xs text-slate-400 font-bold">通路</span>';
                    }
                    
                    cell.onclick = () => {
                        state.editLayout[r][c] = isSeat ? 0 : 1;
                        renderEditorGrid();
                    };
                    
                    container.appendChild(cell);
                }
            }
            lucide.createIcons();
        }

        function saveRoomLayout() {
            if (!state.editRoomId) return;
            
            const roomIndex = appData.rooms.findIndex(r => r.id === state.editRoomId);
            if (roomIndex === -1) return;
            
            const newName = document.getElementById('edit-room-name').value.trim();
            if (!newName) {
                alert('教室名を入力してください。');
                return;
            }

            appData.rooms[roomIndex].name = newName;
            appData.rooms[roomIndex].rows = state.editLayout.length;
            appData.rooms[roomIndex].cols = state.editLayout[0].length;
            appData.rooms[roomIndex].layout = JSON.parse(JSON.stringify(state.editLayout));
            
            saveData();
            renderAdminRoomList();
            renderRoomTabs();
            alert('設定を保存しました。');
        }

        function deleteCurrentRoom() {
            if (!state.editRoomId) return;
            if (appData.rooms.length <= 1) {
                alert('最後の1つは削除できません。');
                return;
            }
            if (confirm('この教室を削除しますか？\n※予約データもこの教室の分は見えなくなります。')) {
                appData.rooms = appData.rooms.filter(r => r.id !== state.editRoomId);
                state.editRoomId = '';
                state.currentRoomId = appData.rooms[0].id;
                saveData();
                renderAdminRoomList();
                renderRoomTabs();
                
                document.getElementById('editor-empty').classList.remove('hidden');
                document.getElementById('editor-container').classList.add('hidden');
            }
        }

        // アプリ起動
        init();
    </script>
</body>
</html>